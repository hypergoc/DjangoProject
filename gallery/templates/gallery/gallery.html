<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallery</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .gallery-item .card {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .gallery-item.selected .card {
            border: 3px solid #007bff;
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
        }
        .controls {
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: .25rem;
        }
    </style>
</head>
<body>

<div class="container mt-4">
    <h2 class="mb-4">Gallery</h2>

    <div class="controls mb-3">
        {% csrf_token %}
        <label for="side-selector" class="mr-2">Connection Side:</label>
        <select id="side-selector" class="form-control d-inline-block" style="width: auto;">
            <option value="L">Left</option>
            <option value="R">Right</option>
            <option value="T">Top</option>
            <option value="B">Bottom</option>
        </select>
        <button id="save-ai-connection-btn" class="btn btn-primary ml-2" disabled>Spremi ai_labeled info</button>
        <p class="text-muted mt-2 mb-0">Use Ctrl+Click to select exactly two images.</p>
    </div>

    <div id="image-gallery" class="row">
        {% for image in images %}
        <div class="col-6 col-sm-4 col-md-3 mb-4 gallery-item" data-id="{{ image.id }}">
            <div class="card">
                <img src="{{ image.path.url }}" class="card-img-top" alt="Image {{ image.id }}">
                <div class="card-body p-2">
                    <p class="card-text text-center">Image ID: {{ image.id }}</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const gallery = document.getElementById('image-gallery');
    const saveBtn = document.getElementById('save-ai-connection-btn');
    const sideSelector = document.getElementById('side-selector');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    let selectedImages = [];

    gallery.addEventListener('click', function(event) {
        const galleryItem = event.target.closest('.gallery-item');
        if (!galleryItem) return;

        if (event.ctrlKey) {
            handleCtrlClick(galleryItem);
        } else {
            handleSingleClick(galleryItem);
        }
        
        saveBtn.disabled = selectedImages.length !== 2;
    });

    function handleCtrlClick(item) {
        const imageId = item.dataset.id;
        const isSelected = item.classList.contains('selected');

        if (isSelected) {
            item.classList.remove('selected');
            selectedImages = selectedImages.filter(id => id !== imageId);
        } else {
            if (selectedImages.length < 2) {
                item.classList.add('selected');
                selectedImages.push(imageId);
            } else {
                alert('You can only select up to 2 images.');
            }
        }
    }

    function handleSingleClick(item) {
        const imageId = item.dataset.id;
        const isCurrentlySelected = item.classList.contains('selected');
        
        document.querySelectorAll('.gallery-item.selected').forEach(el => {
            el.classList.remove('selected');
        });

        if (!isCurrentlySelected || selectedImages.length !== 1) {
            item.classList.add('selected');
            selectedImages = [imageId];
        } else {
            selectedImages = [];
        }
    }

    saveBtn.addEventListener('click', function() {
        if (selectedImages.length !== 2) {
            alert('Please select exactly two images.');
            return;
        }

        const payload = {
            image1_id: selectedImages[0],
            image2_id: selectedImages[1],
            side: sideSelector.value
        };

        fetch("{% url 'gallery:save_ai_connection' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.message || 'Server error'); });
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                alert(data.message);
                document.querySelectorAll('.gallery-item.selected').forEach(item => {
                    item.classList.remove('selected');
                });
                selectedImages = [];
                saveBtn.disabled = true;
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred: ' + error.message);
        });
    });
});
</script>

</body>
</html>