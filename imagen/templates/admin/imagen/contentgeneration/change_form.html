{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
    {{ block.super }}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/css/lightbox.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox.min.js"></script>
    <style>
        .custom-admin-button {
            margin-left: 10px;
            vertical-align: middle;
            height: 2.5em;
        }
        .ajax-status {
            margin-left: 10px;
            font-weight: bold;
        }
        .image-gallery-container {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        .image-gallery-container h3 {
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .image-gallery-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        .thumbnail-wrapper {
            position: relative;
            width: 150px;
            height: 150px;
        }
        .thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .thumbnail:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
{% endblock %}

{% block after_field_sets %}
    {{ block.super }}
    <fieldset class="module aligned">
        <h3>Image Gallery</h3>
        <div id="image-gallery" class="image-gallery-container">
            <div id="image-gallery-grid" class="image-gallery-grid">
                <p>Save or create the item first to see or generate images.</p>
            </div>
        </div>
    </fieldset>
{% endblock %}


{% block admin_change_form_document_ready %}
{{ block.super }}
<script>
(function($) {
    $(document).ready(function() {
        // Ispravan način za dohvaćanje ID-a. Ako ne postoji u contextu (na add stranici), bit će null.
        let objectId = {% if object_id %}'{{ object_id }}'{% else %}null{% endif %};
        let isAddForm = (objectId === null);

        const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
        const geminiUrl = "{% url 'imagen:ajax_gemini_request' %}";

        function showStatus(element, message, isError) {
            let statusDiv = element.siblings('.ajax-status');
            if (!statusDiv.length) {
                statusDiv = $('<span class="ajax-status"></span>');
                element.after(statusDiv);
            }
            statusDiv.text(message).css('color', isError ? '#ba2121' : '#41763f');
        }

        const geminiContainer = $('.form-row.field-gemini_request .readonly').length ? $('.form-row.field-gemini_request .readonly') : $('#id_gemini_request');
        const geminiButton = $('<button type="button" class="button custom-admin-button" id="gemini-request-btn">Pošalji upit</button>');
        geminiContainer.after(geminiButton);

        $('#gemini-request-btn').on('click', function(e) {
            e.preventDefault();
            const geminiText = $('#id_gemini_request').val();
            if (!geminiText.trim()) {
                alert('Gemini Request polje je prazno.');
                return;
            }

            $.ajax({
                url: geminiUrl,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    'gemini_request_text': geminiText,
                    'object_id': objectId // Šalje null ako je `isAddForm` true
                }),
                headers: { 'X-CSRFToken': csrfToken },
                beforeSend: () => {
                    $(this).prop('disabled', true).text('Slanje...');
                    showStatus($(this), '', false);
                },
                success: (data) => {
                    if (data.success) {
                        $('#id_prompt').val(data.prompt);
                        let statusMessage = 'Odgovor primljen i spremljen!';
                        
                        // Ako smo bili na 'add' formi, sada imamo ID i moramo ažurirati stanje stranice
                        if (isAddForm && data.new_object_id) {
                            objectId = data.new_object_id;
                            isAddForm = false;
                            
                            // Ažuriraj URL u browseru bez reloada
                            const newUrl = window.location.pathname.replace('/add/', `/${objectId}/change/`);
                            window.history.pushState({path: newUrl}, '', newUrl);
                            
                            // Promijeni naslov stranice da reflektira promjenu
                            $('h1').text($('h1').text().replace('Add', 'Change'));
                            
                            statusMessage = 'Objekt kreiran! Sada možete generirati slike.';
                        }
                        showStatus($(this), statusMessage, false);
                    } else {
                        showStatus($(this), 'Greška: ' + (data.error || 'Nepoznata greška.'), true);
                    }
                },
                error: (xhr) => showStatus($(this), 'Server greška: ' + (xhr.responseJSON?.error || xhr.statusText), true),
                complete: () => $(this).prop('disabled', false).text('Pošalji upit')
            });
        });
        
        const promptContainer = $('.form-row.field-prompt .readonly').length ? $('.form-row.field-prompt .readonly') : $('#id_prompt');
        const imagenButton = $('<button type="button" class="button custom-admin-button" id="imagen-request-btn">Generiraj Slike</button>');
        promptContainer.after(imagenButton);
        
        $('#imagen-request-btn').on('click', function(e) {
            e.preventDefault();
            if (isAddForm) {
                alert('Molimo prvo pošaljite Gemini upit kako bi se objekt kreirao.');
                return;
            }
            alert('Logika za generiranje slika još nije implementirana. Objekt ID je: ' + objectId);
        });

    });
})(django.jQuery);
</script>
{% endblock %}